<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .save-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .save-slot {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #4a4a4a;
            transition: all 0.3s ease;
        }
        .save-slot:hover {
            border-color: #5a5a5a;
            background: #404040;
        }
        .save-slot.empty {
            border-color: #333;
            opacity: 0.7;
        }
        .save-thumbnail {
            width: 100%;
            height: 120px;
            background: #2a2a2a;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .save-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .save-thumbnail.empty {
            color: #666;
            font-size: 14px;
        }
        .save-info {
            margin-bottom: 15px;
        }
        .save-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .save-status {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .save-time {
            color: #999;
            font-size: 12px;
        }
        .save-actions {
            display: flex;
            gap: 10px;
        }
        button {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #5a5a5a;
        }
        button:disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }
        .save-btn {
            background: #28a745;
        }
        .save-btn:hover {
            background: #218838;
        }
        .load-btn {
            background: #007bff;
        }
        .load-btn:hover {
            background: #0056b3;
        }
        .overwrite-btn {
            background: #ffc107;
            color: #000;
        }
        .overwrite-btn:hover {
            background: #e0a800;
        }
        .clear-btn {
            background: #dc3545;
        }
        .clear-btn:hover {
            background: #c82333;
        }
        .status {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .game-state {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Save System Test</h1>
    
    <div class="test-section">
        <h2>Save System Status</h2>
        <div class="status" id="system-status">
            Initializing...
        </div>
        <div class="controls">
            <button id="init-system">Initialize System</button>
            <button id="clear-all">Clear All Saves</button>
            <button id="export-slot">Export Slot 0</button>
            <button id="import-slot">Import to Slot 0</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Save Slots</h2>
        <div class="save-slots" id="save-slots">
            <!-- Save slots will be populated here -->
        </div>
    </div>

    <div class="test-section">
        <h2>Current Game State</h2>
        <div class="controls">
            <button id="simulate-game-state">Simulate Game State</button>
            <button id="randomize-state">Randomize State</button>
        </div>
        <div class="game-state" id="game-state">
            No game state loaded
        </div>
    </div>

    <script type="module">
        import { SaveSystem } from './src/engine/save/SaveSystem.js';
        import { SaveGameV1, PlayerState, Vector2 } from './src/engine/save/SaveTypes.js';

        let saveSystem = null;
        let currentGameState = null;

        // DOM elements
        const systemStatus = document.getElementById('system-status');
        const saveSlotsContainer = document.getElementById('save-slots');
        const gameStateDisplay = document.getElementById('game-state');

        // Initialize save system
        async function initializeSaveSystem() {
            try {
                systemStatus.textContent = 'Initializing save system...';
                saveSystem = new SaveSystem();
                await saveSystem.initialize();
                systemStatus.textContent = 'Save system initialized successfully';
                await updateSaveSlotsDisplay();
            } catch (error) {
                console.error('Failed to initialize save system:', error);
                systemStatus.textContent = `Error: ${error.message}`;
            }
        }

        // Update save slots display
        async function updateSaveSlotsDisplay() {
            if (!saveSystem) return;

            try {
                const saveSlots = await saveSystem.listSaves();
                
                saveSlotsContainer.innerHTML = '';
                
                saveSlots.forEach((slot, index) => {
                    const slotElement = createSaveSlotElement(slot, index);
                    saveSlotsContainer.appendChild(slotElement);
                });
            } catch (error) {
                console.error('Failed to update save slots display:', error);
            }
        }

        // Create save slot element
        function createSaveSlotElement(saveSlot, slotIndex) {
            const slotDiv = document.createElement('div');
            slotDiv.className = `save-slot ${saveSlot.isEmpty ? 'empty' : ''}`;
            
            const hasData = !saveSlot.isEmpty && saveSlot.saveData;
            
            slotDiv.innerHTML = `
                <div class="save-thumbnail ${saveSlot.isEmpty ? 'empty' : ''}">
                    ${hasData && saveSlot.saveData.thumbnail ? 
                        `<img src="${saveSlot.saveData.thumbnail}" alt="Save thumbnail">` : 
                        'Empty Slot'
                    }
                </div>
                <div class="save-info">
                    <div class="save-title">Slot ${slotIndex + 1}</div>
                    <div class="save-status">
                        ${hasData ? `Level ${saveSlot.saveData.level}` : 'Empty'}
                    </div>
                    <div class="save-time">
                        ${hasData ? new Date(saveSlot.saveData.timestamp).toLocaleString() : ''}
                    </div>
                </div>
                <div class="save-actions">
                    <button class="save-btn" data-slot="${slotIndex}" ${!currentGameState ? 'disabled' : ''}>
                        Save
                    </button>
                    <button class="load-btn" data-slot="${slotIndex}" ${!hasData ? 'disabled' : ''}>
                        Load
                    </button>
                    <button class="overwrite-btn" data-slot="${slotIndex}" ${!hasData || !currentGameState ? 'disabled' : ''}>
                        Overwrite
                    </button>
                    <button class="clear-btn" data-slot="${slotIndex}" ${!hasData ? 'disabled' : ''}>
                        Clear
                    </button>
                </div>
            `;

            // Add event listeners
            const saveBtn = slotDiv.querySelector('.save-btn');
            const loadBtn = slotDiv.querySelector('.load-btn');
            const overwriteBtn = slotDiv.querySelector('.overwrite-btn');
            const clearBtn = slotDiv.querySelector('.clear-btn');

            saveBtn.addEventListener('click', () => performSave(slotIndex));
            loadBtn.addEventListener('click', () => performLoad(slotIndex));
            overwriteBtn.addEventListener('click', () => performOverwrite(slotIndex));
            clearBtn.addEventListener('click', () => performClear(slotIndex));

            return slotDiv;
        }

        // Perform save operation
        async function performSave(slotIndex) {
            if (!saveSystem || !currentGameState) {
                alert('Save system not initialized or no game state');
                return;
            }

            try {
                const result = await saveSystem.save(slotIndex, currentGameState);
                
                if (result.success) {
                    alert(`Game saved successfully to slot ${slotIndex + 1}`);
                    await updateSaveSlotsDisplay();
                } else {
                    alert(`Failed to save: ${result.error}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save game');
            }
        }

        // Perform load operation
        async function performLoad(slotIndex) {
            if (!saveSystem) {
                alert('Save system not initialized');
                return;
            }

            try {
                const result = await saveSystem.load(slotIndex);
                
                if (result.success && result.saveData) {
                    currentGameState = result.saveData;
                    updateGameStateDisplay();
                    alert(`Game loaded successfully from slot ${slotIndex + 1}`);
                } else {
                    alert(`Failed to load: ${result.error}`);
                }
            } catch (error) {
                console.error('Load error:', error);
                alert('Failed to load game');
            }
        }

        // Perform overwrite operation
        async function performOverwrite(slotIndex) {
            if (!saveSystem || !currentGameState) {
                alert('Save system not initialized or no game state');
                return;
            }

            if (confirm(`Overwrite save in slot ${slotIndex + 1}?`)) {
                await performSave(slotIndex);
            }
        }

        // Perform clear operation
        async function performClear(slotIndex) {
            if (!saveSystem) {
                alert('Save system not initialized');
                return;
            }

            if (confirm(`Clear save in slot ${slotIndex + 1}?`)) {
                try {
                    const success = await saveSystem.clear(slotIndex);
                    if (success) {
                        alert(`Slot ${slotIndex + 1} cleared successfully`);
                        await updateSaveSlotsDisplay();
                    } else {
                        alert('Failed to clear slot');
                    }
                } catch (error) {
                    console.error('Clear error:', error);
                    alert('Failed to clear slot');
                }
            }
        }

        // Update game state display
        function updateGameStateDisplay() {
            if (!currentGameState) {
                gameStateDisplay.textContent = 'No game state loaded';
                return;
            }

            gameStateDisplay.textContent = JSON.stringify(currentGameState, null, 2);
        }

        // Generate sample game state
        function generateSampleGameState() {
            const playerState: PlayerState = {
                position: { x: Math.random() * 100, y: Math.random() * 100 },
                velocity: { x: 0, y: 0 },
                health: Math.floor(Math.random() * 100) + 1,
                maxHealth: 100,
                hasSword: Math.random() > 0.5,
                isOnGround: Math.random() > 0.5,
                facingDirection: Math.random() > 0.5 ? 'left' : 'right',
                animationState: 'idle',
                invulnerable: false,
                invulnerabilityTimer: 0
            };

            const gameState: Omit<SaveGameV1, 'slot' | 'timestamp'> = {
                version: '1.0',
                level: Math.floor(Math.random() * 10) + 1,
                room: Math.floor(Math.random() * 5) + 1,
                player: playerState,
                timer: Math.random() * 300,
                flags: {
                    hasKey: Math.random() > 0.5,
                    doorUnlocked: Math.random() > 0.5,
                    bossDefeated: Math.random() > 0.7
                },
                rngSeed: Math.floor(Math.random() * 1000000),
                enemies: [
                    {
                        id: 'enemy1',
                        type: 'guard',
                        position: { x: 50, y: 50 },
                        health: 30,
                        state: 'patrol'
                    }
                ],
                thumbnail: '',
                packId: 'example-pack',
                packVersion: '1.0.0'
            };

            return gameState;
        }

        // Event listeners
        document.getElementById('init-system').addEventListener('click', initializeSaveSystem);
        
        document.getElementById('clear-all').addEventListener('click', async () => {
            if (!saveSystem) {
                alert('Save system not initialized');
                return;
            }

            if (confirm('Clear all save slots?')) {
                try {
                    const success = await saveSystem.clearAll();
                    if (success) {
                        alert('All save slots cleared');
                        await updateSaveSlotsDisplay();
                    } else {
                        alert('Failed to clear all slots');
                    }
                } catch (error) {
                    console.error('Clear all error:', error);
                    alert('Failed to clear all slots');
                }
            }
        });

        document.getElementById('export-slot').addEventListener('click', async () => {
            if (!saveSystem) {
                alert('Save system not initialized');
                return;
            }

            try {
                const exportData = await saveSystem.exportSave(0);
                if (exportData) {
                    const blob = new Blob([exportData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'save-slot-0.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('No save data in slot 0');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export save');
            }
        });

        document.getElementById('import-slot').addEventListener('click', async () => {
            if (!saveSystem) {
                alert('Save system not initialized');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const result = await saveSystem.importSave(0, text);
                        if (result.success) {
                            alert('Save imported successfully');
                            await updateSaveSlotsDisplay();
                        } else {
                            alert(`Failed to import: ${result.error}`);
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Failed to import save');
                    }
                }
            };
            input.click();
        });

        document.getElementById('simulate-game-state').addEventListener('click', () => {
            currentGameState = generateSampleGameState();
            updateGameStateDisplay();
            updateSaveSlotsDisplay();
        });

        document.getElementById('randomize-state').addEventListener('click', () => {
            if (currentGameState) {
                currentGameState = generateSampleGameState();
                updateGameStateDisplay();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Save system test page loaded');
        });
    </script>
</body>
</html> 